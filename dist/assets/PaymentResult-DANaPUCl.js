import{j as s}from"./vendor-bootstrap-CDKGkX3Y.js";import{r as e}from"./vendor-react-CSr-5IoM.js";import{b as a,u as n}from"./vendor-router-D9z9DFGH.js";import{h as i,ac as t,ae as l,ad as r,af as c,ab as d,ag as o}from"./index-BzUMVULD.js";import"./vendor-redux-DhM9Zidd.js";import"./vendor-query-BOtKDBw2.js";import"./vendor-ui-C66qigmO.js";const m=()=>{var m;const[u]=a(),p=n(),[h,j]=e.useState("checking"),[x,v]=e.useState("Loading payment information..."),[N,y]=e.useState(null),[g,b]=e.useState(null),[f,w]=e.useState(5),[P,k]=e.useState(null),[S,_]=e.useState(0),[C,D]=e.useState(null),I=e.useRef(null),T=e.useRef(!1);e.useEffect((()=>{const s=u.get("status"),e=u.get("tracking_id");if(e)I.current=e,A(e);else if("error"===s){const s=u.get("message")||"Payment verification failed";j("error"),v("Payment Error"),k(s)}else j("error"),v("Invalid Payment Callback"),k("Missing payment tracking information. Please contact support if payment was deducted.");return()=>{C&&clearInterval(C)}}),[]),e.useEffect((()=>{if("success"===h&&f>0){const s=setTimeout((()=>{w(f-1)}),1e3);return()=>clearTimeout(s)}"success"===h&&0===f&&(window.location.href="/")}),[h,f,p]);const A=(s,e=!1)=>{return a=void 0,n=null,t=function*(){var a,n,t;if(!T.current)try{T.current=!0,e||(j("verifying"),v("Verifying your payment with backend..."));const a=yield i(`subscriptions/payment-status/${s}`,{});if(1!==a.code||!a.data)throw new Error("Invalid response from backend");{const{subscription:e,manifest:n,is_active:i,is_paid:t}=a.data;if(y(e),b(n),"Completed"===e.payment_status&&"Active"===e.status)j("success"),v("Payment Successful!"),k(null),localStorage.removeItem("pending_subscription"),localStorage.removeItem("subscription_status_cache"),C&&(clearInterval(C),D(null));else if("Failed"===e.payment_status||"Failed"===e.status)j("failed"),v("Payment Failed"),k(e.cancelled_reason||"Your payment could not be processed. Please try again."),C&&(clearInterval(C),D(null));else if("Processing"===e.payment_status||"Pending"===e.payment_status){if(j("pending"),v("Payment Being Processed"),k("Your payment is being verified. This usually takes a few minutes."),!C&&S<20){const e=window.setInterval((()=>{_((s=>s+1)),A(s,!0)}),1e4);D(e)}}else j("pending"),v("Payment Status Unknown"),k("Unable to determine payment status. Please refresh or contact support.")}}catch(l){"ECONNABORTED"===l.code||l.message.includes("timeout")?(v("Request timeout. Retrying..."),S<3?setTimeout((()=>{_(S+1),A(s,!0)}),3e3):(j("error"),v("Connection Timeout"),k("Unable to verify payment status due to network issues. Please try again or contact support if payment was deducted."))):404===(null==(a=l.response)?void 0:a.status)?(j("error"),v("Subscription Not Found"),k("Could not find your subscription. Please contact support if payment was deducted.")):(j("error"),v("Verification Failed"),k((null==(t=null==(n=l.response)?void 0:n.data)?void 0:t.message)||"Unable to verify payment status. Please contact support if payment was deducted."))}finally{T.current=!1}},new Promise(((s,e)=>{var i=s=>{try{r(t.next(s))}catch(a){e(a)}},l=s=>{try{r(t.throw(s))}catch(a){e(a)}},r=e=>e.done?s(e.value):Promise.resolve(e.value).then(i,l);r((t=t.apply(a,n)).next())}));var a,n,t},V=()=>{I.current&&(_(0),A(I.current,!1))},F=()=>{p("/dashboard")},M=s=>{if(!s)return"N/A";try{return new Date(s).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch(e){return s}};return s.jsx("div",{className:"payment-result-container",children:s.jsxs("div",{className:"payment-result-card",children:["checking"===h&&s.jsxs("div",{className:"payment-status checking",children:[s.jsx(t,{className:"status-icon spinning"}),s.jsx("h2",{children:"Loading Payment Information..."}),s.jsx("p",{children:"Initializing verification process"}),s.jsx("div",{className:"loading-bar",children:s.jsx("div",{className:"loading-progress"})})]}),"verifying"===h&&s.jsxs("div",{className:"payment-status checking",children:[s.jsx(t,{className:"status-icon spinning"}),s.jsx("h2",{children:"Verifying Payment..."}),s.jsx("p",{children:"Please wait while we confirm your payment with our backend"}),s.jsx("div",{className:"loading-bar",children:s.jsx("div",{className:"loading-progress"})}),s.jsxs("div",{className:"verification-info",children:[s.jsx(l,{}),s.jsx("p",{children:"Do not close this page. Verification in progress..."})]})]}),"success"===h&&s.jsxs("div",{className:"payment-status success",children:[s.jsx(r,{className:"status-icon"}),s.jsx("h2",{children:"üéâ Payment Successful!"}),s.jsx("p",{className:"success-message",children:"Your subscription is now active and ready to use!"}),N&&s.jsxs("div",{className:"subscription-details",children:[s.jsx("h3",{children:"Subscription Details"}),s.jsxs("div",{className:"detail-row",children:[s.jsx("span",{className:"detail-label",children:"Plan:"}),s.jsx("span",{className:"detail-value",children:(null==(m=N.plan)?void 0:m.name)||"Premium Plan"})]}),s.jsxs("div",{className:"detail-row",children:[s.jsx("span",{className:"detail-label",children:"Status:"}),s.jsx("span",{className:"detail-value success-badge",children:N.status})]}),s.jsxs("div",{className:"detail-row",children:[s.jsx("span",{className:"detail-label",children:"Payment Status:"}),s.jsx("span",{className:"detail-value success-badge",children:N.payment_status})]}),s.jsxs("div",{className:"detail-row",children:[s.jsx("span",{className:"detail-label",children:"Amount Paid:"}),s.jsxs("span",{className:"detail-value",children:[N.currency," ",Math.round(N.amount_paid).toLocaleString()]})]}),s.jsxs("div",{className:"detail-row",children:[s.jsx("span",{className:"detail-label",children:"Valid From:"}),s.jsx("span",{className:"detail-value",children:M(N.start_date_time)})]}),s.jsxs("div",{className:"detail-row",children:[s.jsx("span",{className:"detail-label",children:"Valid Until:"}),s.jsx("span",{className:"detail-value",children:M(N.end_date_time)})]}),N.payment_method&&s.jsxs("div",{className:"detail-row",children:[s.jsx("span",{className:"detail-label",children:"Payment Method:"}),s.jsx("span",{className:"detail-value",children:N.payment_method})]})]}),s.jsxs("div",{className:"countdown-message",children:["Redirecting in ",f," seconds..."]}),s.jsxs("div",{className:"success-actions",children:[s.jsxs("button",{className:"btn-primary",onClick:()=>{window.location.href="/subscription/my-subscriptions"},children:[s.jsx(r,{}),s.jsx("span",{children:"View My Subscriptions"})]}),s.jsxs("button",{className:"btn-secondary",onClick:F,children:[s.jsx(c,{}),s.jsx("span",{children:"Go to Dashboard"})]})]})]}),"failed"===h&&s.jsxs("div",{className:"payment-status failed",children:[s.jsx(d,{className:"status-icon"}),s.jsx("h2",{children:"‚ùå Payment Failed"}),s.jsx("p",{className:"error-message",children:x}),P&&s.jsx("div",{className:"error-details",children:s.jsx("p",{children:P})}),N&&s.jsxs("div",{className:"subscription-details",children:[s.jsx("h3",{children:"Transaction Details"}),s.jsxs("div",{className:"detail-row",children:[s.jsx("span",{className:"detail-label",children:"Status:"}),s.jsx("span",{className:"detail-value error-badge",children:N.status})]}),s.jsxs("div",{className:"detail-row",children:[s.jsx("span",{className:"detail-label",children:"Payment Status:"}),s.jsx("span",{className:"detail-value error-badge",children:N.payment_status})]}),s.jsxs("div",{className:"detail-row",children:[s.jsx("span",{className:"detail-label",children:"Tracking ID:"}),s.jsx("span",{className:"detail-value",children:N.pesapal_tracking_id})]})]}),s.jsxs("div",{className:"failed-actions",children:[s.jsxs("button",{className:"btn-retry",onClick:()=>{localStorage.removeItem("pending_subscription"),window.location.href="/subscription/plans"},children:[s.jsx(o,{}),s.jsx("span",{children:"Try Again"})]}),s.jsxs("button",{className:"btn-secondary",onClick:F,children:[s.jsx(c,{}),s.jsx("span",{children:"Go to Dashboard"})]})]}),s.jsxs("div",{className:"support-message",children:[s.jsx("p",{children:"Need help? Contact our support team:"}),s.jsx("a",{href:"https://wa.me/16479686445",target:"_blank",rel:"noopener noreferrer",className:"whatsapp-link",children:"üí¨ WhatsApp: +1 (647) 968-6445"})]})]}),"pending"===h&&s.jsxs("div",{className:"payment-status pending",children:[s.jsx(t,{className:"status-icon spinning"}),s.jsx("h2",{children:"‚è≥ Payment Processing"}),s.jsx("p",{className:"pending-message",children:x}),P&&s.jsx("div",{className:"pending-details",children:s.jsx("p",{children:P})}),N&&s.jsxs("div",{className:"subscription-details",children:[s.jsx("h3",{children:"Transaction Details"}),s.jsxs("div",{className:"detail-row",children:[s.jsx("span",{className:"detail-label",children:"Status:"}),s.jsx("span",{className:"detail-value pending-badge",children:N.status})]}),s.jsxs("div",{className:"detail-row",children:[s.jsx("span",{className:"detail-label",children:"Payment Status:"}),s.jsx("span",{className:"detail-value pending-badge",children:N.payment_status})]}),s.jsxs("div",{className:"detail-row",children:[s.jsx("span",{className:"detail-label",children:"Amount:"}),s.jsxs("span",{className:"detail-value",children:[N.currency," ",Math.round(N.amount_paid).toLocaleString()]})]})]}),C&&s.jsxs("div",{className:"auto-check-info",children:[s.jsx(l,{}),s.jsxs("p",{children:["Auto-checking status every 10 seconds... (Check ",S+1,"/20)"]})]}),s.jsxs("div",{className:"pending-actions",children:[s.jsxs("button",{className:"btn-primary",onClick:V,disabled:T.current,children:[s.jsx(o,{}),s.jsx("span",{children:"Check Status Now"})]}),s.jsxs("button",{className:"btn-secondary",onClick:F,children:[s.jsx(c,{}),s.jsx("span",{children:"Go to Dashboard"})]})]}),s.jsxs("div",{className:"info-message",children:[s.jsx("p",{children:"üí° Tip: Mobile Money payments may take up to 5 minutes to process."}),s.jsx("p",{children:"You can safely close this page - you'll receive a notification when payment is confirmed."})]})]}),"error"===h&&s.jsxs("div",{className:"payment-status failed",children:[s.jsx(d,{className:"status-icon"}),s.jsxs("h2",{children:["‚ö†Ô∏è ",x]}),P&&s.jsx("div",{className:"error-details",children:s.jsx("p",{children:P})}),s.jsxs("div",{className:"failed-actions",children:[I.current&&s.jsxs("button",{className:"btn-retry",onClick:V,children:[s.jsx(o,{}),s.jsx("span",{children:"Retry Verification"})]}),s.jsxs("button",{className:"btn-secondary",onClick:F,children:[s.jsx(c,{}),s.jsx("span",{children:"Go to Dashboard"})]})]}),s.jsxs("div",{className:"support-message",children:[s.jsx("p",{children:"Need help? Contact our support team:"}),s.jsx("a",{href:"https://wa.me/16479686445",target:"_blank",rel:"noopener noreferrer",className:"whatsapp-link",children:"üí¨ WhatsApp: +1 (647) 968-6445"})]})]})]})})};export{m as default};
