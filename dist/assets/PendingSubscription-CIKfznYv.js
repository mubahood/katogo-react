var e=(e,n,s)=>new Promise(((a,i)=>{var t=e=>{try{c(s.next(e))}catch(n){i(n)}},l=e=>{try{c(s.throw(e))}catch(n){i(n)}},c=e=>e.done?a(e.value):Promise.resolve(e.value).then(t,l);c((s=s.apply(e,n)).next())}));import{j as n}from"./vendor-bootstrap-CDKGkX3Y.js";import{r as s}from"./vendor-react-CSr-5IoM.js";import{a8 as a,a3 as i,a9 as t,aa as l,ab as c,ac as r,ad as o}from"./index-C_CdsbTE.js";import{u as d}from"./vendor-router-D9z9DFGH.js";import"./vendor-redux-DhM9Zidd.js";import"./vendor-query-BOtKDBw2.js";import"./vendor-ui-rAPUFMbG.js";const u=()=>{const u=d(),{hasActiveSubscription:p,subscriptionStatus:m}=a(),[h,v]=s.useState(!0),[j,x]=s.useState(null),[g,y]=s.useState(!1),[b,f]=s.useState(!1),[N,w]=s.useState(null),[P,S]=s.useState(!1),[k,_]=s.useState(!1),[C,I]=s.useState(0),[E,F]=s.useState(0);s.useEffect((()=>{p&&(window.location.href="/")}),[p,m]),s.useEffect((()=>{A()}),[]),s.useEffect((()=>{if(!j)return;if(C>=180)return;if(E>=5)return void w("Unable to verify payment status. Please refresh the page or contact support.");const e=setInterval((()=>{g||b||k||(R(),I((e=>e+1)))}),1e4);return()=>{clearInterval(e)}}),[j,g,b,k,C,E]);const A=()=>e(void 0,null,(function*(){var e,n,s,a;try{v(!0),w(null);const e=yield i.getPendingSubscription();if(!e||"object"!=typeof e)throw new Error("Invalid response format");if(e.pending_subscription){const n=e.pending_subscription;if(!(n&&n.id&&n.plan))throw new Error("Invalid subscription data structure");x(n)}else u("/subscription/plans",{replace:!0})}catch(t){if(404===(null==(e=t.response)?void 0:e.status)||500===(null==(n=t.response)?void 0:n.status))setTimeout((()=>u("/subscription/plans",{replace:!0})),1e3);else if("ERR_NETWORK"===t.code||"ECONNABORTED"===t.code)w("Network error. Please check your connection and try again.");else{const e=(null==(a=null==(s=t.response)?void 0:s.data)?void 0:a.message)||t.message||"Failed to load pending subscription";w(e)}}finally{v(!1)}})),O=()=>{const n=setInterval((()=>e(void 0,null,(function*(){"success"===(yield R())&&clearInterval(n)}))),5e3);setTimeout((()=>{clearInterval(n)}),6e5)},R=()=>e(void 0,null,(function*(){if(!j||!j.id)return F((e=>e+1)),"failed";try{const n=yield i.checkPendingPaymentStatus(j.id);if(!n||"object"!=typeof n)return F((e=>e+1)),"failed";if(F(0),"Active"===n.status||!0===n.is_active){try{localStorage.removeItem("pending_subscription_check")}catch(e){}return window.location.href="/","success"}return"pending"}catch(n){return F((e=>e+1)),"failed"}}));return h?n.jsx("div",{className:"pending-subscription-page",children:n.jsxs("div",{className:"loading-container",children:[n.jsx("div",{className:"spinner-large"}),n.jsx("p",{children:"Loading pending subscription..."})]})}):j?n.jsx("div",{className:"pending-subscription-page",children:n.jsxs("div",{className:"pending-container",children:[n.jsxs("div",{className:"warning-banner",children:[n.jsx(t,{className:"warning-icon"}),n.jsxs("div",{className:"warning-content",children:[n.jsx("h3",{children:"Pending Subscription Payment"}),n.jsx("p",{children:"You have an unpaid subscription that needs your attention"})]})]}),n.jsxs("div",{className:"pending-card",children:[n.jsxs("div",{className:"card-header",children:[n.jsx(l,{className:"clock-icon"}),n.jsx("h2",{children:"Pending Subscription"})]}),n.jsxs("div",{className:"subscription-details",children:[n.jsxs("div",{className:"detail-row",children:[n.jsx("span",{className:"label",children:"Plan:"}),n.jsx("span",{className:"value plan-name",children:j.plan.name})]}),n.jsxs("div",{className:"detail-row",children:[n.jsx("span",{className:"label",children:"Amount:"}),n.jsxs("span",{className:"value amount",children:[j.plan.currency," ",Math.round(j.amount).toLocaleString()]})]}),n.jsxs("div",{className:"detail-row",children:[n.jsx("span",{className:"label",children:"Status:"}),n.jsxs("span",{className:"value status-pending",children:[n.jsx(l,{})," Pending Payment"]})]}),n.jsxs("div",{className:"detail-row",children:[n.jsx("span",{className:"label",children:"Order ID:"}),n.jsx("span",{className:"value order-id",children:j.order_tracking_id})]}),n.jsxs("div",{className:"detail-row",children:[n.jsx("span",{className:"label",children:"Created:"}),n.jsx("span",{className:"value",children:new Date(j.created_at).toLocaleString()})]})]}),n.jsxs("div",{className:"instructions",children:[n.jsx("h3",{children:"What you need to do:"}),n.jsxs("ol",{children:[n.jsx("li",{children:'Click "Pay Now" to complete your payment via Pesapal'}),n.jsx("li",{children:"Complete the payment in the new tab that opens"}),n.jsx("li",{children:'Return here and click "Check Payment Status" to verify'}),n.jsx("li",{children:"Your subscription will activate immediately after successful payment"})]})]}),N&&n.jsxs("div",{className:"error-message",children:[n.jsx(c,{}),n.jsx("span",{children:N})]}),n.jsxs("div",{className:"action-buttons",children:[n.jsx("button",{className:"btn-pay-now",onClick:()=>e(void 0,null,(function*(){var e,n;if(j)try{if(f(!0),w(null),j.payment_url)return window.open(j.payment_url,"_blank"),void f(!1);const e=yield i.initiatePendingPayment(j.id);e.redirect_url&&(localStorage.setItem("pending_subscription_check",JSON.stringify({subscription_id:j.id,order_tracking_id:e.order_tracking_id||j.order_tracking_id,started_at:(new Date).toISOString()})),window.open(e.redirect_url,"_blank"),O())}catch(s){w((null==(n=null==(e=s.response)?void 0:e.data)?void 0:n.message)||"Failed to initiate payment. Please try again.")}finally{f(!1)}})),disabled:b||g||k,children:b?n.jsxs(n.Fragment,{children:[n.jsx(r,{className:"spinner-icon"}),n.jsx("span",{children:"Opening Payment..."})]}):n.jsxs(n.Fragment,{children:[n.jsx(o,{}),n.jsx("span",{children:"Pay Now"})]})}),n.jsx("button",{className:"btn-check-status",onClick:()=>e(void 0,null,(function*(){var e,n;if(j)try{y(!0),w(null);const e=yield i.checkPendingPaymentStatus(j.id);"Active"===e.status?(localStorage.removeItem("pending_subscription_check"),window.location.href="/"):"Pending"===e.status?alert("⏳ Payment is still pending. Please complete the payment or try again later."):alert("❌ Payment verification failed. Please try paying again or contact support.")}catch(s){w((null==(n=null==(e=s.response)?void 0:e.data)?void 0:n.message)||"Failed to check payment status. Please try again.")}finally{y(!1)}})),disabled:g||b||k,children:g?n.jsxs(n.Fragment,{children:[n.jsx(r,{className:"spinner-icon"}),n.jsx("span",{children:"Checking..."})]}):n.jsxs(n.Fragment,{children:[n.jsx(o,{}),n.jsx("span",{children:"Check Payment Status"})]})}),n.jsxs("button",{className:"btn-cancel",onClick:()=>S(!0),disabled:k||g||b,children:[n.jsx(c,{}),n.jsx("span",{children:"Cancel Subscription"})]})]}),n.jsxs("div",{className:"auto-check-notice",children:[n.jsx(r,{className:"spinner-small"}),n.jsx("span",{children:"Automatically checking payment status every 10 seconds..."})]})]}),P&&n.jsx("div",{className:"modal-overlay",onClick:()=>S(!1),children:n.jsxs("div",{className:"modal-content",onClick:e=>e.stopPropagation(),children:[n.jsx("h3",{children:"Cancel Subscription?"}),n.jsx("p",{children:"Are you sure you want to cancel this pending subscription?"}),n.jsx("p",{className:"warning-text",children:"This action cannot be undone."}),n.jsxs("div",{className:"modal-actions",children:[n.jsx("button",{className:"btn-confirm-cancel",onClick:()=>e(void 0,null,(function*(){var e,n;if(j)try{_(!0),w(null),yield i.cancelPendingSubscription(j.id),localStorage.removeItem("pending_subscription_check"),alert("Subscription canceled successfully."),u("/subscription/plans")}catch(s){w((null==(n=null==(e=s.response)?void 0:e.data)?void 0:n.message)||"Failed to cancel subscription. Please try again.")}finally{_(!1),S(!1)}})),disabled:k,children:k?"Canceling...":"Yes, Cancel"}),n.jsx("button",{className:"btn-keep",onClick:()=>S(!1),disabled:k,children:"Keep Subscription"})]})]})})]})}):null};export{u as default};
