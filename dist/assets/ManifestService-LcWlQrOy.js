var t=Object.defineProperty,i=(i,e,s)=>((i,e,s)=>e in i?t(i,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[e]=s)(i,"symbol"!=typeof e?e+"":e,s),e=(t,i,e)=>new Promise(((s,r)=>{var n=t=>{try{o(e.next(t))}catch(i){r(i)}},a=t=>{try{o(e.throw(t))}catch(i){r(i)}},o=t=>t.done?s(t.value):Promise.resolve(t.value).then(n,a);o((e=e.apply(t,i)).next())}));import{ak as s,T as r,d as n,h as a}from"./index-C_CdsbTE.js";import"./vendor-bootstrap-CDKGkX3Y.js";import"./vendor-react-CSr-5IoM.js";import"./vendor-redux-DhM9Zidd.js";import"./vendor-router-D9z9DFGH.js";import"./vendor-query-BOtKDBw2.js";import"./vendor-ui-rAPUFMbG.js";class o{constructor(t){i(this,"id"),i(this,"title"),i(this,"subtitle"),i(this,"description"),i(this,"image"),i(this,"action_type"),i(this,"action_value"),i(this,"link"),i(this,"is_active"),i(this,"position"),i(this,"created_at"),i(this,"updated_at"),this.id=t.id,this.title=t.title,this.subtitle=t.subtitle,this.description=t.description,this.image=t.image,this.action_type=t.action_type,this.action_value=t.action_value,this.link=t.link,this.is_active=t.is_active,this.position=t.position,this.created_at=t.created_at,this.updated_at=t.updated_at}getImageUrl(){return s.img(this.image)}isActive(){return"Yes"===this.is_active}getActionUrl(){switch(this.action_type){case"category":return`/products?category=${this.action_value}`;case"product":return`/product/${this.action_value}`;case"vendor":return`/vendor/${this.action_value}`;case"url":return this.action_value||"#";default:return this.link||"#"}}static fromApiData(t){return new o({id:t.id,title:t.title||t.name||"Featured Banner",subtitle:t.subtitle,description:t.description,image:t.image||t.banner_image||t.photo,action_type:t.action_type,action_value:t.action_value,link:t.link,is_active:t.is_active||"Yes",position:t.position||0,created_at:t.created_at,updated_at:t.updated_at})}static sortByPosition(t){return[...t].sort(((t,i)=>(t.position||0)-(i.position||0)))}static filterActive(t){return t.filter((t=>t.isActive()))}}const c=class t{constructor(){i(this,"cachedManifest",null),i(this,"cacheExpiry",3e5),i(this,"lastCacheTime",0),i(this,"cachedSubscriptionManifest",null),i(this,"subscriptionCacheExpiry",6e4),i(this,"lastSubscriptionCacheTime",0),i(this,"isLoadingSubscription",!1),i(this,"subscriptionLoadingPromise",null),i(this,"cachedCategories",null)}static getInstance(){return t.instance||(t.instance=new t),t.instance}loadHomepageManifest(t=!1){return e(this,null,(function*(){const i=Date.now();if(!t&&this.cachedManifest&&i-this.lastCacheTime<this.cacheExpiry)return this.cachedManifest;try{const t={banners:[],categories:[],topProducts:[],featuredCategories:[],isLoading:!0,lastUpdated:new Date},[e,s,r,n]=yield Promise.allSettled([this.loadBanners(),this.loadCategories(),this.loadVendors(),this.loadTopProducts()]);return"fulfilled"===e.status&&(t.banners=e.value),"fulfilled"===s.status&&(t.categories=s.value,t.featuredCategories=this.getFeaturedCategories(s.value)),"fulfilled"===n.status&&(t.topProducts=n.value),t.isLoading=!1,this.cachedManifest=t,this.lastCacheTime=i,t}catch(e){return r.error("Failed to load homepage data"),{banners:[],categories:[],topProducts:[],featuredCategories:[],isLoading:!1,lastUpdated:new Date}}}))}loadBanners(){return e(this,null,(function*(){try{const t=(yield n.getBannerCategories()).filter((t=>t.banner_image&&""!==t.banner_image.trim())).map(((t,i)=>o.fromApiData({id:t.id,title:t.category,subtitle:`Shop ${t.category}`,description:`Discover amazing ${t.category.toLowerCase()} products`,image:t.banner_image,action_type:"category",action_value:t.id.toString(),is_active:"Yes",position:i})));return 0===t.length?[]:o.sortByPosition(t)}catch(t){return[]}}))}createFallbackBanners(){return[{id:1,title:"Welcome to UgFlix",subtitle:"Your one-stop shop",description:"Discover amazing products at unbeatable prices",image:"media/auth/bg1.jpg",action_type:"url",action_value:"/products",is_active:"Yes",position:1},{id:2,title:"Super Deals",subtitle:"Up to 50% Off",description:"Limited time offers on selected items",image:"media/auth/bg2.jpg",action_type:"url",action_value:"/products?sort_by=price_1",is_active:"Yes",position:2},{id:3,title:"New Arrivals",subtitle:"Fresh Products",description:"Check out our latest additions",image:"media/auth/bg3.jpg",action_type:"url",action_value:"/products?sort_by=date_added",is_active:"Yes",position:3}].map((t=>o.fromApiData(t)))}loadCategories(){return e(this,null,(function*(){return this.cachedCategories&&this.cachedCategories.length>0||(this.cachedCategories=yield n.getCategories()),this.cachedCategories}))}loadVendors(){return e(this,null,(function*(){return(yield n.getVendors()).slice(0,12)}))}loadTopProducts(){return e(this,null,(function*(){return(yield n.getProducts({page:1,limit:12,sort_by:"metric",sort_order:"desc",in_stock:!0})).data}))}getFeaturedCategories(t){return t.filter((t=>t.isShownInCategories())).slice(0,8)}clearCache(){this.cachedManifest=null,this.cachedCategories=null,this.lastCacheTime=0,this.cachedSubscriptionManifest=null,this.lastSubscriptionCacheTime=0}getCachedManifest(){const t=Date.now();return this.cachedManifest&&t-this.lastCacheTime<this.cacheExpiry?this.cachedManifest:null}hasActiveSubscription(){return e(this,null,(function*(){try{const t=yield this.getSubscriptionManifest();if(!t||!t.subscription)return!1;return!0===t.subscription.has_active_subscription}catch(t){return!1}}))}getSubscriptionManifest(t=!1){return e(this,null,(function*(){const i=Date.now();if(!t&&this.cachedSubscriptionManifest&&i-this.lastSubscriptionCacheTime<this.subscriptionCacheExpiry)return this.cachedSubscriptionManifest;if(this.isLoadingSubscription&&this.subscriptionLoadingPromise)return this.subscriptionLoadingPromise;this.isLoadingSubscription=!0,this.subscriptionLoadingPromise=this.fetchSubscriptionManifestFromServer();try{const t=yield this.subscriptionLoadingPromise;return this.cachedSubscriptionManifest=t,this.lastSubscriptionCacheTime=i,t}finally{this.isLoadingSubscription=!1,this.subscriptionLoadingPromise=null}}))}fetchSubscriptionManifestFromServer(){return e(this,null,(function*(){try{const t=yield a("manifest",{});if(1===t.code&&t.data){return t.data}throw new Error("Invalid manifest response structure")}catch(t){throw t}}))}getSubscriptionDetails(){return e(this,null,(function*(){try{return(yield this.getSubscriptionManifest()).subscription||null}catch(t){return null}}))}isExpiringSoon(t=7){return e(this,null,(function*(){const i=yield this.getSubscriptionDetails();return!(!i||!i.has_active_subscription)&&(i.days_remaining>0&&i.days_remaining<=t)}))}isInGracePeriod(){return e(this,null,(function*(){const t=yield this.getSubscriptionDetails();return!0===(null==t?void 0:t.is_in_grace_period)}))}redirectToSubscription(t){t&&sessionStorage.setItem("subscriptionRedirectReason",t),window.location.href="/subscription/plans"}clearSubscriptionCache(){this.cachedSubscriptionManifest=null,this.lastSubscriptionCacheTime=0}refreshSubscription(){return e(this,null,(function*(){return this.getSubscriptionManifest(!0)}))}checkAccessAndRedirect(t=!0){return e(this,null,(function*(){const i=yield this.hasActiveSubscription();return!i&&t?(this.redirectToSubscription("Access denied - subscription required"),!1):i}))}};i(c,"instance");let u=c;const l=u.getInstance();export{u as ManifestService,l as default};
